<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Snapshots for unit tests using the tinytest framework for R. Includes expectations to test base R and ggplot2 plots as well as console output from print().">
<title>Snapshots for Unit Tests using the tinytest Framework • tinysnapshot</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Snapshots for Unit Tests using the tinytest Framework">
<meta property="og:description" content="Snapshots for unit tests using the tinytest framework for R. Includes expectations to test base R and ggplot2 plots as well as console output from print().">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">tinysnapshot</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.0.2.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/vincentarelbundock/tinysnapshot/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="tinysnapshot-snapshots-for-unit-tests-in-r-using-the-tinytest-framework">
<code>tinysnapshot</code>: Snapshots for unit tests in <code>R</code> using the <code>tinytest</code> framework.<a class="anchor" aria-label="anchor" href="#tinysnapshot-snapshots-for-unit-tests-in-r-using-the-tinytest-framework"></a>
</h1></div>
<p><code>tinytest</code> is a <a href="https://cran.r-project.org/package=tinytest" class="external-link">“lightweight, no-dependency, but full-featured package for unit testing in <code>R</code>”</a> created by Mark van der Loo.</p>
<p><code>tinysnapshot</code> extends <code>tinytest</code> with expectations to test plots (base <code>R</code> or <code>ggplot2</code>) and <code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code> output. In particular, <code>tinysnapshot</code> allows:</p>
<ol style="list-style-type: decimal">
<li>Taking snapshots of known “target” plots or <code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code> output.</li>
<li>Testing if the “current” plot or <code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code> output matches the target.</li>
<li>Displaying a visual “diff” to facilitate comparison when a test fails.</li>
</ol>
<p>Under the hood, <code>tinysnapshot</code> uses <a href="https://cran.r-project.org/package=magick" class="external-link">the <code>magick</code> package</a> by Jeroen Ooms to read and compare images, and <a href="https://CRAN.R-project.org/package=diffobj" class="external-link">the <code>diffobj</code>package</a> by Brodie Gaslam to compare printed output.</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"tinysnapshot"</span><span class="op">)</span></span></code></pre></div>
<p>Install the development version of <code>tinysnapshot</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"vincentarelbundock/tinysnapshot"</span><span class="op">)</span></span></code></pre></div>
<p>You may also want to install additional packages to benefit from extra features:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rsvg"</span>, <span class="st">"ragg"</span>, <span class="st">"svglite"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visual-expectations-expect_snapshot_plot">Visual expectations: <code>expect_snapshot_plot()</code>
<a class="anchor" aria-label="anchor" href="#visual-expectations-expect_snapshot_plot"></a>
</h2>
<p>To test a visual expectation, we create an <code>R</code> script, give it a name which starts with “test”, and save it in the <code>inst/tinytest/</code> directory of our package.</p>
<p>Each test script with visual expectations must include these two lines at the top:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/markvanderloo/tinytest" class="external-link">"tinytest"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tinytest/man/using.html" class="external-link">using</a></span><span class="op">(</span><span class="st">"tinysnapshot"</span><span class="op">)</span></span></code></pre></div>
<p>When users run the <code>tinytest</code> suite, the <code><a href="reference/expect_snapshot_plot.html">expect_snapshot_plot()</a></code> and <code><a href="reference/expect_snapshot_print.html">expect_snapshot_print()</a></code> expectations are executed and three main states can arise:</p>
<ul>
<li>On first run:<ul><li>Test fails and saves a visual snapshot in the <code>inst/tinytest/_tinysnapshot</code> directory.</li></ul>
</li>
<li>On subsequent runs:<ul>
<li>Test passes when the plot matches the snapshot file.</li>
<li>Test fails and saves comparison files in <code>inst/tinytest/_tinysnapshot_review</code>
</li>
</ul>
</li>
</ul>
<div class="section level3">
<h3 id="ggplot2">
<code>ggplot2</code><a class="anchor" aria-label="anchor" href="#ggplot2"></a>
</h3>
<p>In this example script, we test two <code>ggplot2</code> objects:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://ggplot2.tidyverse.org" class="external-link">"ggplot2"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/markvanderloo/tinytest" class="external-link">"tinytest"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tinytest/man/using.html" class="external-link">using</a></span><span class="op">(</span><span class="st">"tinysnapshot"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">mpg</span>, <span class="va">wt</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">mpg</span>, <span class="va">hp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># On first run: fail and save a snapshot</span></span>
<span><span class="co"># On subsequent runs: pass</span></span>
<span><span class="fu"><a href="reference/expect_snapshot_plot.html">expect_snapshot_plot</a></span><span class="op">(</span><span class="va">p1</span>, label <span class="op">=</span> <span class="st">"ggplot2_example"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Always fails</span></span>
<span><span class="fu"><a href="reference/expect_snapshot_plot.html">expect_snapshot_plot</a></span><span class="op">(</span><span class="va">p2</span>, label <span class="op">=</span> <span class="st">"ggplot2_example"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="base-r-graphics">Base <code>R</code> graphics<a class="anchor" aria-label="anchor" href="#base-r-graphics"></a>
</h3>
<p>Testing a Base <code>R</code> plot is slightly different: we need to supply a function which prints the plot:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/markvanderloo/tinytest" class="external-link">"tinytest"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tinytest/man/using.html" class="external-link">using</a></span><span class="op">(</span><span class="st">"tinysnapshot"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">hp</span>, <span class="va">mtcars</span><span class="op">$</span><span class="va">wt</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">hp</span>, <span class="va">mtcars</span><span class="op">$</span><span class="va">mpg</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># On first run: fail and save a snapshot</span></span>
<span><span class="co"># On subsequent runs: pass</span></span>
<span><span class="fu"><a href="reference/expect_snapshot_plot.html">expect_snapshot_plot</a></span><span class="op">(</span><span class="va">p1</span>, label <span class="op">=</span> <span class="st">"base_example"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Always fails</span></span>
<span><span class="fu"><a href="reference/expect_snapshot_plot.html">expect_snapshot_plot</a></span><span class="op">(</span><span class="va">p2</span>, label <span class="op">=</span> <span class="st">"base_example"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="options-and-arguments">Options and arguments<a class="anchor" aria-label="anchor" href="#options-and-arguments"></a>
</h3>
<p><code>expect_snapshot_plot</code> supports 4 graphics devices: <code>png</code> and <code>ragg</code> for PNG, and <code>svg</code> and <code>svglite</code> for SVG. It can set different values for the height and width of the pictures (pixels for PNG and inches for SVG). Most of the arguments can also be fixed globally using options:</p>
<pre class="{r}"><code><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>tinysnapshot_device <span class="op">=</span> <span class="st">"svglite"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>tinysnapshot_height <span class="op">=</span> <span class="fl">7</span><span class="op">)</span> <span class="co"># inches</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>tinysnapshot_width <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>tinysnapshot_tol <span class="op">=</span> <span class="fl">200</span><span class="op">)</span> <span class="co"># pixels</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="visual-diff">Visual diff<a class="anchor" aria-label="anchor" href="#visual-diff"></a>
</h3>
<p>When (not “if”) tests fail, <code>tinysnapshot</code> will save diff files in the <code>inst/tinytest/_tinysnapshot_review/</code> folder. Diff files for plots look like this:</p>
<p><img src="https://user-images.githubusercontent.com/987057/210011007-757b7f6d-4b57-4f77-b586-22e7d13bf9f5.png"></p>
</div>
</div>
<div class="section level2">
<h2 id="print-expectations-expect_snapshot_print">Print expectations: <code>expect_snapshot_print()</code>
<a class="anchor" aria-label="anchor" href="#print-expectations-expect_snapshot_print"></a>
</h2>
<p>First, we save this script in <code>inst/tinytest/test-print.R</code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/markvanderloo/tinytest" class="external-link">"tinytest"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tinytest/man/using.html" class="external-link">using</a></span><span class="op">(</span><span class="st">"tinysnapshot"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">hp</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">gear</span><span class="op">)</span>, <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/expect_snapshot_print.html">expect_snapshot_print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span>, label <span class="op">=</span> <span class="st">"print-lm_summary"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">gear</span><span class="op">)</span>, <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/expect_snapshot_print.html">expect_snapshot_print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod2</span><span class="op">)</span>, label <span class="op">=</span> <span class="st">"print-lm_summary"</span><span class="op">)</span></span></code></pre></div>
<p>Then, we run the tests.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tinytest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tinytest/man/run_test_file.html" class="external-link">run_test_file</a></span><span class="op">(</span><span class="st">"inst/tinytest/test-print.R"</span><span class="op">)</span></span></code></pre></div>
<p>The first time we run the test, it fails and saves a reference file. The second time we run it, there is already a reference text file, so only one of the tests fails. This is the expected result.</p>
<div class="section level3">
<h3 id="print-diff">Print diff<a class="anchor" aria-label="anchor" href="#print-diff"></a>
</h3>
<p>When tests fail, <code>tinytest</code> will return a diff like this one:</p>
<pre class="{r}"><code>    test-print.R..................    2 tests 2 fails 0.3s
    ----- FAILED[]: test-print.R&lt;12--12&gt;
    call| expect_snapshot_print(summary(mod1), label = "print-lm_summary")
    diff| Missing reference file.
    info| diffobj::printDiff()
    ----- FAILED[]: test-print.R&lt;15--15&gt;
    call| expect_snapshot_print(summary(mod2), label = "print-lm_summary")
    diff| &lt; ref                                                           
    diff| &gt; x                                                             
    diff| @@ 1,21 / 1,20 @@                                               
    diff| 
    diff| Call:                                                         
    diff| &lt; lm(formula = mpg ~ hp + factor(gear), data = mtcars)          
    diff| &gt; lm(formula = mpg ~ factor(gear), data = mtcars)               
    diff| 
    diff| Residuals:                                                    
    diff| Min      1Q  Median      3Q     Max                       
    diff| &lt; -4.4937 -2.3586 -0.8277  2.2753  7.7287                       
    diff| &gt; -6.7333 -3.2333 -0.9067  2.8483  9.3667                       
    diff| 
    diff| Coefficients:                                                 
    diff| Estimate Std. Error t value Pr(&gt;|t|)            
    diff| &lt; (Intercept)   27.88193    2.10908  13.220 1.47e-13 ***        
    diff| &lt; hp            -0.06685    0.01105  -6.052 1.59e-06 ***        
    diff| &gt; (Intercept)     16.107      1.216  13.250 7.87e-14 ***        
    diff| &lt; factor(gear)4  2.63486    1.55164   1.698 0.100575            
    diff| &gt; factor(gear)4    8.427      1.823   4.621 7.26e-05 ***        
    diff| &lt; factor(gear)5  6.57476    1.64268   4.002 0.000417 ***        
    diff| &gt; factor(gear)5    5.273      2.431   2.169   0.0384 *          
    diff| ---                                                           
    diff| Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    diff| 
    diff| &lt; Residual standard error: 3.154 on 28 degrees of freedom       
    diff| &gt; Residual standard error: 4.708 on 29 degrees of freedom       
    diff| &lt; Multiple R-squared:  0.7527,    Adjusted R-squared:  0.7262   
    diff| &gt; Multiple R-squared:  0.4292,    Adjusted R-squared:  0.3898   
    diff| &lt; F-statistic: 28.41 on 3 and 28 DF,  p-value: 1.217e-08        
    diff| &gt; F-statistic:  10.9 on 2 and 29 DF,  p-value: 0.0002948        
    diff| 
    info| diffobj::printDiff()
    
    Warning message:
    Creating reference file: _tinysnapshot/print-lm_summary.txt </code></pre>
<p>When there are too many failures, <code>tinytest</code> will not always print the full diff. In those cases, you can save the <code>tinytest</code> object and print it out manually while specifying the <code>nlong</code> argument:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">tinytest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tinytest/man/run_test_dir.html" class="external-link">run_test_dir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">results</span>, nlong <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="updating-snapshots">Updating snapshots<a class="anchor" aria-label="anchor" href="#updating-snapshots"></a>
</h2>
<p>To update the snapshot for a test, simply delete the relevant snapshot from the <code>inst/tinytest/_tinysnapshot</code> folder and run the test suite again. As when we ran the suite for the very first time, this will report a failure but generate a new snapshot.</p>
</div>
<div class="section level2">
<h2 id="cran-continuous-integration-and-deterministic-plots">CRAN, continuous integration, and deterministic plots<a class="anchor" aria-label="anchor" href="#cran-continuous-integration-and-deterministic-plots"></a>
</h2>
<p>In general, the images produced by <code>R</code> are not <em>deterministic</em>, meaning that they can vary slightly based on the operating system, graphics device, <code>R</code> version, etc. Unfortunately, this means that visual expectations will often fail on CRAN, where tests are run on many different platforms.</p>
<p>Other packages <a href="https://vdiffr.r-lib.org/" class="external-link">like <code>vdiffr</code></a> ship with an embedded version <code>svglite</code> and their own fonts to ensure deterministic plots. <code>tinysnapshot</code> does not do that (yet). Here are some steps you can take to make testing images less painful in continuous integration:</p>
<ul>
<li>Use <code>options(tinysnapshot_os = "Darwin")</code> (or “Windows”, “Linux”, etc.) to indicate the operating system on which the snapshots were created, and to skip visual snapshots on other operating systems. Available in <code>tinysnapshot</code> 0.0.3 or the development version from Github.</li>
<li>Run continuous integration tests using the same <code>R</code> version and operating system as the one used to generate the snapshots.</li>
<li>Use the <code>svglite</code> graphics device by default: <code>options(tinysnapshot_device = "svglite")</code>
</li>
<li>Skip visual tests on CRAN.</li>
</ul>
</div>
<div class="section level2">
<h2 id="minimal-package-example">Minimal package example<a class="anchor" aria-label="anchor" href="#minimal-package-example"></a>
</h2>
<p>We now create a minimal <code>R</code> package to illustrate how to use <code>tinysnapshot</code> in the “real world.”</p>
<p>Create a <code>temp</code> directory and use the <code>pkgKitten</code> package to create an ultra-minimalist package (an alternative would be the <code>usethis</code> package):</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/markvanderloo/tinytest" class="external-link">tinytest</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/eddelbuettel/pkgkitten" class="external-link">pkgKitten</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/pkgKitten/man/kitten.html" class="external-link">kitten</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"testpkg"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a>    Creating directories ...</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a>    Creating DESCRIPTION ...</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a>    Creating NAMESPACE ...</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a>    Adding pkgKitten overrides.</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true"></a>    <span class="op">&gt;</span><span class="er">&gt;</span><span class="st"> </span>added .gitignore file</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true"></a>    <span class="op">&gt;</span><span class="er">&gt;</span><span class="st"> </span>added .Rbuildignore file</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true"></a>    <span class="op">&gt;</span><span class="er">&gt;</span><span class="st"> </span>added tinytest support</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true"></a>    Consider reading the documentation <span class="cf">for</span> all the packaging details.</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true"></a>    A good start is the <span class="st">'Writing R Extensions'</span> manual.</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true"></a>    And run <span class="st">'R CMD check'</span>. Run it frequently. And think of those kittens.</span></code></pre></div>
<p>Download an example test script from the <code>tinysnapshot</code> repository:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span></span>
<span>    url <span class="op">=</span> <span class="st">"https://raw.githubusercontent.com/vincentarelbundock/tinysnapshot/main/inst/tinytest/test-png.R"</span>,</span>
<span>    destfile <span class="op">=</span> <span class="st">"testpkg/inst/tinytest/test-png.R"</span>,</span>
<span>    quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Our package now includes 7 tests: 1 created by default by the <code><a href="https://rdrr.io/pkg/tinytest/man/puppy.html" class="external-link">puppy()</a></code> function, and 6 tests in the <code>test-png.R</code> script. When we run <code>tinytest</code> the first time, the 6 <code>test-png.R</code> tests fail, but some generate snapshots in PNG format:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd</a></span><span class="op">(</span><span class="st">"testpkg"</span><span class="op">)</span></span>
<span><span class="fu">tinytest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tinytest/man/run_test_dir.html" class="external-link">run_test_dir</a></span><span class="op">(</span><span class="st">"inst/tinytest"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a>    test_testpkg.R................    <span class="dv">1</span> tests OK 22ms</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a>    test<span class="op">-</span>png.R..................    <span class="dv">6</span> tests <span class="dv">6</span> fails <span class="fl">0.8</span>s</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a>    <span class="op">-----</span><span class="st"> </span>FAILED[]<span class="op">:</span><span class="st"> </span>test<span class="op">-</span>png.R<span class="op">&lt;</span><span class="dv">15</span><span class="op">--</span><span class="dv">15</span><span class="op">&gt;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a><span class="st">    </span>call<span class="op">|</span><span class="st"> </span><span class="kw">expect_snapshot_plot</span>(p1, <span class="st">"base"</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a>    diff<span class="op">|</span><span class="st"> </span><span class="dv">0</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true"></a>    info<span class="op">|</span><span class="st"> </span>pixels</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true"></a>    <span class="op">-----</span><span class="st"> </span>FAILED[]<span class="op">:</span><span class="st"> </span>test<span class="op">-</span>png.R<span class="op">&lt;</span><span class="dv">18</span><span class="op">--</span><span class="dv">18</span><span class="op">&gt;</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true"></a><span class="st">    </span>call<span class="op">|</span><span class="st"> </span><span class="er">**</span>expect_snapshot_plot<span class="op">**</span>(p2, <span class="st">"base"</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true"></a>    diff<span class="op">|</span><span class="st"> </span><span class="dv">3232</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true"></a>    info<span class="op">|</span><span class="st"> </span>pixels</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true"></a>    <span class="op">-----</span><span class="st"> </span>FAILED[]<span class="op">:</span><span class="st"> </span>test<span class="op">-</span>png.R<span class="op">&lt;</span><span class="dv">25</span><span class="op">--</span><span class="dv">25</span><span class="op">&gt;</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true"></a><span class="st">    </span>call<span class="op">|</span><span class="st"> </span><span class="kw">expect_snapshot_plot</span>(p1, <span class="st">"ggplot2_variable"</span>)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true"></a>    diff<span class="op">|</span><span class="st"> </span><span class="dv">0</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true"></a>    info<span class="op">|</span><span class="st"> </span>pixels</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true"></a>    FAILED[]<span class="op">:</span><span class="st"> </span>test<span class="op">-</span>png.R<span class="op">&lt;</span><span class="dv">28</span><span class="op">--</span><span class="dv">28</span><span class="op">&gt;</span><span class="st"> </span><span class="kw">expect_snapshot_plot</span>(p2, <span class="st">"ggplot2_variable"</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true"></a>    FAILED[]<span class="op">:</span><span class="st"> </span>test<span class="op">-</span>png.R<span class="op">&lt;</span><span class="dv">31</span><span class="op">--</span><span class="dv">31</span><span class="op">&gt;</span><span class="st"> </span><span class="kw">expect_snapshot_plot</span>(p3, <span class="st">"ggplot2_theme"</span>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true"></a>    FAILED[]<span class="op">:</span><span class="st"> </span>test<span class="op">-</span>png.R<span class="op">&lt;</span><span class="dv">34</span><span class="op">--</span><span class="dv">34</span><span class="op">&gt;</span><span class="st"> </span><span class="kw">expect_snapshot_plot</span>(p4, <span class="st">"ggplot2_theme"</span>)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true"></a>    </span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true"></a>    Showing <span class="dv">6</span> out of <span class="dv">7</span> results<span class="op">:</span><span class="st"> </span><span class="dv">6</span> fails, <span class="dv">1</span> <span class="kw">passes</span> (<span class="fl">0.8</span>s)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true"></a>    Warning messages<span class="op">:</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true"></a><span class="st">    </span><span class="dv">1</span><span class="op">:</span><span class="st"> </span>Creating reference file<span class="op">:</span><span class="st"> </span>_tinysnapshot<span class="op">/</span>base.png </span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true"></a>    <span class="dv">2</span><span class="op">:</span><span class="st"> </span>Creating reference file<span class="op">:</span><span class="st"> </span>_tinysnapshot<span class="op">/</span>ggplot2_variable.png </span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true"></a>    <span class="dv">3</span><span class="op">:</span><span class="st"> </span>Creating reference file<span class="op">:</span><span class="st"> </span>_tinysnapshot<span class="op">/</span>ggplot2_theme.png </span></code></pre></div>
<p>The second time we run the test suite, only 3 of the <code>test-png.R</code> tests fail:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tinytest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tinytest/man/run_test_dir.html" class="external-link">run_test_dir</a></span><span class="op">(</span><span class="st">"inst/tinytest"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a>    test_testpkg.R................    <span class="dv">1</span> tests OK 6ms</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a>    test<span class="op">-</span>png.R....................    <span class="dv">6</span> tests <span class="dv">3</span> fails <span class="fl">0.6</span>s</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true"></a>    <span class="op">-----</span><span class="st"> </span>FAILED[]<span class="op">:</span><span class="st"> </span>test<span class="op">-</span>png.R<span class="op">&lt;</span><span class="dv">18</span><span class="op">--</span><span class="dv">18</span><span class="op">&gt;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true"></a><span class="st">    </span>call<span class="op">|</span><span class="st"> </span><span class="kw">expect_snapshot_plot</span>(p2, <span class="st">"base"</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true"></a>    diff<span class="op">|</span><span class="st"> </span><span class="dv">3232</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true"></a>    info<span class="op">|</span><span class="st"> </span>pixels</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true"></a>    <span class="op">-----</span><span class="st"> </span>FAILED[]<span class="op">:</span><span class="st"> </span>test<span class="op">-</span>png.R<span class="op">&lt;</span><span class="dv">28</span><span class="op">--</span><span class="dv">28</span><span class="op">&gt;</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true"></a><span class="st">    </span>call<span class="op">|</span><span class="st"> </span><span class="kw">expect_snapshot_plot</span>(p2, <span class="st">"ggplot2_variable"</span>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true"></a>    diff<span class="op">|</span><span class="st"> </span><span class="dv">33536</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true"></a>    info<span class="op">|</span><span class="st"> </span>pixels</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true"></a>    <span class="op">-----</span><span class="st"> </span>FAILED[]<span class="op">:</span><span class="st"> </span>test<span class="op">-</span>png.R<span class="op">&lt;</span><span class="dv">34</span><span class="op">--</span><span class="dv">34</span><span class="op">&gt;</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true"></a><span class="st">    </span>call<span class="op">|</span><span class="st"> </span><span class="kw">expect_snapshot_plot</span>(p4, <span class="st">"ggplot2_theme"</span>)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true"></a>    diff<span class="op">|</span><span class="st"> </span><span class="dv">191955</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true"></a>    info<span class="op">|</span><span class="st"> </span>pixels</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true"></a>    </span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true"></a>    Showing <span class="dv">3</span> out of <span class="dv">7</span> results<span class="op">:</span><span class="st"> </span><span class="dv">3</span> fails, <span class="dv">4</span> <span class="kw">passes</span> (<span class="fl">0.7</span>s)</span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://cloud.r-project.org/package=tinysnapshot" class="external-link">View on CRAN</a></li>
<li><a href="https://github.com/vincentarelbundock/tinysnapshot/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/vincentarelbundock/tinysnapshot/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li>GPL (&gt;= 3)</li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing tinysnapshot</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Vincent Arel-Bundock <br><small class="roles"> Author, maintainer, copyright holder </small> <a href="https://orcid.org/0000-0003-2042-7063" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Vincent Arel-Bundock.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
